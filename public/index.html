<!DOCTYPE html>
<html>
<head>
  <title>Projects & Documents</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>

<div id="auth-container">

  <!-- REGISTER -->
  <div id="register-section">
    <h3>Register</h3>
    <input id="regName" placeholder="Name" />
    <input id="regEmail" placeholder="Email" />
    <input id="regPassword" type="password" placeholder="Password" />
    <button onclick="register()">Register</button>
  </div>

  <hr />

  <!-- LOGIN -->
  <div id="login-section">
    <h3>Login</h3>
    <input id="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button onclick="login()">Login</button>
  </div>

  <!-- LOGOUT -->
  <div id="logout-section" style="display:none;">
    <button onclick="logout()">Logout</button>
  </div>

</div>

<hr />

<h1>Projects</h1>

<input id="projectName" placeholder="New project name" />
<button onclick="addProject()">Add Project</button>

<ul id="projects"></ul>

<h2 id="docHeader" style="display:none;">Documents</h2>

<input id="docTitle" placeholder="New document title" disabled />
<button id="addDocBtn" onclick="addDocument()" disabled>Add Document</button>

<ul id="documents"></ul>

<script>

let selectedProject = null;

function updateAuthUI() {
  const token = localStorage.getItem('token');

  const registerSection = document.getElementById('register-section');
  const loginSection = document.getElementById('login-section');
  const logoutSection = document.getElementById('logout-section');

  if (token) {
    // Logged in
    registerSection.style.display = 'none';
    loginSection.style.display = 'none';
    logoutSection.style.display = 'block';
  } else {
    // Logged out
    registerSection.style.display = 'block';
    loginSection.style.display = 'block';
    logoutSection.style.display = 'none';
  }
}

async function register() {
  const name = document.getElementById('regName').value;
  const email = document.getElementById('regEmail').value;
  const password = document.getElementById('regPassword').value;

  const res = await fetch('/api/auth/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, email, password })
  });

  if (!res.ok) {
    const data = await res.json();
    alert(data.error || 'Registration failed');
    return;
  }

  alert('Registration successful. You can now log in.');
  updateAuthUI();
}

async function login() {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;

  const res = await fetch('/api/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password })
  });

  if (!res.ok) {
    alert('Invalid credentials');
    return;
  }

  const data = await res.json();
  localStorage.setItem('token', data.token);

  updateAuthUI();
  loadProjects();
}

function authHeaders() {
  const token = localStorage.getItem('token');
  return token
    ? { Authorization: `Bearer ${token}` }
    : {};
}

function logout() {
  localStorage.removeItem('token');

  selectedProject = null;
  document.getElementById('projects').innerHTML = '';
  document.getElementById('documents').innerHTML = '';
  document.getElementById('docHeader').style.display = 'none';

  updateAuthUI();
}

function isLoggedIn() {
  return !!localStorage.getItem('token');
}

async function loadProjects() {
  const res = await fetch('/api/projects');
  const projects = await res.json();

  const ul = document.getElementById('projects');
  ul.innerHTML = '';

  projects.forEach(p => {
    const li = document.createElement('li');

    // âœ… APPLY HIGHLIGHT
    if (p.id === selectedProject) {
      li.classList.add('selected-project');
    }

    li.innerHTML = `
      <span>${p.name}</span>
      <button
        style="margin-left: 8px;"
        onclick="event.stopPropagation(); deleteProject(${p.id})"
      >
        X
      </button>
    `;

    li.onclick = () => selectProject(p.id);
    ul.appendChild(li);
  });
}

function selectProject(id) {
  selectedProject = Number(id);
  document.getElementById('docHeader').style.display = 'block';
  document.getElementById('docTitle').disabled = false;
  document.getElementById('addDocBtn').disabled = false;
  loadProjects();
  loadDocuments();
}

async function loadDocuments() {
  const res = await fetch(`/api/projects/${selectedProject}/documents`);
  const docs = await res.json();
  const ul = document.getElementById('documents');
  ul.innerHTML = '';
  docs.forEach(d => {
    const li = document.createElement('li');
    li.innerHTML = `
        <span>${d.title}</span>
        <button style="margin-left: 8px;" onclick="deleteDocument(${d.id})">X</button>
    `;
    ul.appendChild(li);
  });
}

async function addProject() {
  if (!isLoggedIn()) return;
  const name = document.getElementById('projectName').value;
  await fetch('/api/projects', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeaders()},
    body: JSON.stringify({ name })
  });
  document.getElementById('projectName').value = '';
  loadProjects();
}

async function addDocument() {
  if (!selectedProject) return;
  const title = document.getElementById('docTitle').value;
  const res = await fetch(`/api/projects/${selectedProject}/documents`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeaders()},
    body: JSON.stringify({ title })
  });

  if (!res.ok) {
    const data = await res.json();
    alert(data.error || 'Failed to create document');
    return;
  }

  document.getElementById('docTitle').value = '';
  loadDocuments();
}

async function deleteProject(projectId) {
  if (!confirm('Delete this project?')) return;

  await fetch(`/api/projects/${projectId}`, {
    method: 'DELETE',
    headers: authHeaders()
  });

  selectedProject = null;
  document.getElementById('documents').innerHTML = '';
  loadProjects();
}

async function deleteDocument(documentId) {
  const confirmed = confirm('Are you sure you want to delete this document?');

  if (!confirmed) return;

  const res = await fetch(`/api/documents/${documentId}`, {
    method: 'DELETE',
    headers: authHeaders()
  });

  if (!res.ok) {
    alert('Failed to delete document');
    return;
  }

  alert('Document deleted');
  loadDocuments();
}

updateAuthUI();

if (localStorage.getItem('token')) {
  loadProjects();
}
</script>

</body>
</html>
